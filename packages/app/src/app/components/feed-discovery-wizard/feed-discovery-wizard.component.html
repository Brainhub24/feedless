<div
  style="flex: 1; display: flex; flex-direction: row"
  class="wizard"
  [ngClass]="{
    'wizard--with-body': discovery?.document.htmlBody,
    'wizard--without-body': !discovery?.document.htmlBody
  }"
>
  <div class="menu">
    <ion-toolbar *ngIf="!discovery || !discovery?.document.htmlBody">
      <form (ngSubmit)="checkClear(); fetchDiscovery()">
        <ion-searchbar
          placeholder="Enter URL"
          class="menu__searchbar"
          name="url"
          (ionChange)="checkClear()"
          [(ngModel)]="fetchOptions.websiteUrl"
        ></ion-searchbar>
      </form>
      <ion-buttons slot="end">
        <ion-button color="dark" (click)="checkClear(); fetchDiscovery()">
          <ion-icon name="search-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>

    <ion-spinner *ngIf="loading"></ion-spinner>

    <ion-accordion-group [value]="['options']" style="flex: 1" [hidden]="loading || !discovery">
      <ion-accordion value="properties" *ngIf="discovery?.document">
        <ion-item slot="header">
          <ion-label>Page Properties</ion-label>
        </ion-item>
        <ion-list slot="content">
          <ion-item>
            <ion-label position="floating">Title</ion-label>
            <ion-input name="title" [readonly]="true" [value]="discovery.document.title" placeholder="empty">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Description</ion-label>
            <ion-input name="description" [readonly]="true" [ngModel]="discovery.document.description" placeholder="empty">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Language</ion-label>
            <ion-input name="language" [readonly]="true" [ngModel]="discovery.document.language" placeholder="empty">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">MimeType</ion-label>
            <ion-input name="mimeType" [readonly]="true" [ngModel]="discovery.document.mimeType" placeholder="empty">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Banner Image</ion-label>
            <ion-input name="imageUrl" [readonly]="true" [ngModel]="discovery.document.imageUrl" placeholder="No URL">
            </ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Favicon</ion-label>
            <ion-input name="favicon" [readonly]="true" [ngModel]="discovery.document.favicon" placeholder="No URL">
            </ion-input>
          </ion-item>
        </ion-list>
      </ion-accordion>
      <ion-accordion value="options" [appFeatureToggle]="featureTogglesEnum.Puppeteer">
        <ion-item slot="header">
          <ion-label>Options</ion-label>
        </ion-item>
        <ion-list slot="content">
<!--          <ion-item>-->
<!--            <ion-checkbox-->
<!--              name="strictMode"-->
<!--              slot="start"-->
<!--              [(ngModel)]="parserOptions.strictMode"-->
<!--            ></ion-checkbox>-->
<!--            <ion-label>Strict Rules</ion-label>-->
<!--          </ion-item>-->
          <ion-item>
            <ion-checkbox
              name="prerender"
              slot="start"
              (ionChange)="pushQueryParam('prerender', fetchOptions.prerender); fetchDiscovery()"
              [(ngModel)]="fetchOptions.prerender"
            ></ion-checkbox>
            <ion-label>Prerender</ion-label>
          </ion-item>
          <ion-item id="open-modal" [button]="true">
            <ion-icon name="logo-javascript" slot="start"></ion-icon>
            <ion-label>Puppeteer Evaluate</ion-label>
          </ion-item>
          <ion-modal trigger="open-modal" (willDismiss)="fetchDiscovery()">
            <ng-template>
              <ion-header>
                <ion-toolbar>
                  <ion-title>Puppeteer Evaluate</ion-title>
                  <ion-buttons slot="end">
                    <ion-button (click)="closeModal()">
                      <ion-icon name="close-outline"></ion-icon>
                    </ion-button>
                  </ion-buttons>
                </ion-toolbar>
              </ion-header>
              <ion-content class="ion-padding">
                <ion-textarea multiple
                              placeholder="Your name"
                              [(ngModel)]="fetchOptions.prerenderScript"></ion-textarea>
              </ion-content>
            </ng-template>
          </ion-modal>

          <ion-item *ngIf="fetchOptions.prerender">
            <ion-label>Wait Until</ion-label>
            <ion-select
              slot="end"
              [required]="true"
              name="wait"
              (ionChange)="
                pushQueryParam('prerenderWaitUntil', fetchOptions.prerenderWaitUntil); fetchDiscovery()
              "
              [(ngModel)]="fetchOptions.prerenderWaitUntil"
            >
              <ion-select-option
                *ngFor="let prerenderWaitUntil of getPrerenderWaitUntilOptions()"
                [value]="prerenderWaitUntil.value"
              >
                {{ prerenderWaitUntil.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ion-list>
      </ion-accordion>

      <!--      <ion-item-->
      <!--        [button]="true"-->
      <!--        [detail]="true"-->
      <!--        *ngIf="discovery?.mimeType?.startsWith('text/html')"-->
      <!--      >-->
      <!--        <ion-label>Reader</ion-label>-->
      <!--      </ion-item>-->

      <ion-accordion
        value="native"
        *ngIf="discovery?.nativeFeeds?.length > 0"
        [disabled]="genericFeed"
      >
        <ion-item slot="header">
          <ion-label
            >{{ discovery?.nativeFeeds?.length }} Native Feeds
            <app-bubble *ngIf="!currentNativeFeed" color="blue"></app-bubble>
          </ion-label>
        </ion-item>
        <ion-list slot="content">
          <ion-item
            [button]="true"
            (click)="pickNativeFeed(nativeFeed)"
            *ngFor="let nativeFeed of discovery?.nativeFeeds"
          >
            <ion-icon name="chevron-forward-outline" slot="start"></ion-icon>
            <ion-label>{{ nativeFeed.title }}</ion-label>
          </ion-item>
        </ion-list>
      </ion-accordion>

      <ion-accordion
        value="generic"
        *ngIf="discovery?.genericFeeds?.feeds.length > 0"
      >
        <ion-item slot="header">
          <ion-label
            >{{ discovery?.genericFeeds?.feeds.length }} Generic Feeds
          </ion-label>
        </ion-item>
        <ion-list slot="content" class="limited">
          <ion-item
            [button]="true"
            (click)="pickGenericFeed(genericFeed)"
            [color]="
              currentGenericFeed?.hash === genericFeed.hash ? 'dark' : undefined
            "
            *ngFor="let genericFeed of discovery?.genericFeeds.feeds"
          >
            <ion-icon name="chevron-forward-outline" slot="start"></ion-icon>
            <ion-label>{{ genericFeed.count }} articles
              <span *ngIf="genericFeed.selectors.paginationXPath">+pagination</span>
              <span *ngIf="genericFeed.selectors.dateXPath">+date</span>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-accordion>

<!--      todo mag implement -->
<!--      <ion-accordion-->
<!--        value="page"-->
<!--        *ngIf="discovery?.document.mimeType?.startsWith('text/html')"-->
<!--      >-->
<!--        <ion-item slot="header">-->
<!--          <ion-label>Partial Page Changes</ion-label>-->
<!--        </ion-item>-->
<!--        <ion-list slot="content">-->
<!--          <ion-item [button]="true">-->
<!--            <ion-icon name="chevron-forward-outline" slot="start"></ion-icon>-->
<!--            <ion-label>Selector</ion-label>-->
<!--          </ion-item>-->
<!--          <ion-list>-->
<!--            <ion-item [button]="true">-->
<!--              <ion-icon name="chevron-forward-outline" slot="start"></ion-icon>-->
<!--              <ion-label>Fulltext</ion-label>-->
<!--            </ion-item>-->
<!--            <ion-item [button]="true">-->
<!--              <ion-icon name="chevron-forward-outline" slot="start"></ion-icon>-->
<!--              <ion-label>Pixel</ion-label>-->
<!--            </ion-item>-->
<!--          </ion-list>-->
<!--        </ion-list>-->
<!--      </ion-accordion>-->

      <ion-accordion value="selectors" *ngIf="currentSelectors">
        <ion-item slot="header">
          <ion-label>
            Selectors
            <app-bubble *ngIf="currentGenericFeed && !currentGenericFeed.selectors.dateXPath"
                        color="blue"></app-bubble>
          </ion-label>
        </ion-item>
        <ion-list slot="content">
          <ion-item>
            <ion-label position="floating">Context</ion-label>
            <ion-input
              name="contextXPath"
              placeholder="xpath from root"
              (ionChange)="pushQueryParam('contextPath', currentSelectors.contextXPath); highlightGenericFeedInIframe()"
              [(ngModel)]="currentSelectors.contextXPath"
            ></ion-input>
<!--            -->
<!--            //*[@id="block-views-block-veranstaltungen-block-1"]/div/div/div/div/div[2]/div[1]/div[1]-->
<!--            //div[1]/div[1]/div[7]/div[1]/div[1]/div[1]/div[1]/div[1]/div[1]/div[1]/div[1]/div[2]/div/div/div-->
<!--            -->
          </ion-item>
          <ion-item>
            <ion-label position="floating">Link</ion-label>
            <ion-input
              name="linkXPath"
              placeholder="relative xpath from context"
              (ionChange)="pushQueryParam('linkPath', currentSelectors.linkXPath)"
              [(ngModel)]="currentSelectors.linkXPath"
            ></ion-input>
          </ion-item>
          <ion-item>
            <ion-label>Extend Context</ion-label>
            <ion-select
              [required]="true"
              name="extendContext"
              (ionChange)="pushQueryParam('extendContent', currentSelectors.extendContext)"
              [(ngModel)]="currentSelectors.extendContext"
            >
              <ion-select-option
                *ngFor="let extendContextOption of getExtendContextOptions()"
                [value]="extendContextOption.value"
              >
                + {{ extendContextOption.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Date</ion-label>
            <ion-input
              name="dateXPath"
              placeholder="relative xpath from context"
              (ionChange)="pushQueryParam('datePath', currentSelectors.dateXPath)"
              [(ngModel)]="currentSelectors.dateXPath"
            ></ion-input>
          </ion-item>
          <ion-item *ngIf="currentSelectors.dateXPath">
            <ion-label>Date is Beginning of Event</ion-label>
            <ion-checkbox
              name="dateIsStartOfEvent"
              [(ngModel)]="currentSelectors.dateIsStartOfEvent"
            ></ion-checkbox>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Pagination</ion-label>
            <ion-input
              name="paginationXPath"
              placeholder="relative xpath from context"
              (ionChange)="pushQueryParam('paginationPath', currentSelectors.paginationXPath)"
              [(ngModel)]="currentSelectors.paginationXPath"
            ></ion-input>
          </ion-item>

        </ion-list>
      </ion-accordion>

      <ion-list [appFeatureToggle]="featureTogglesEnum.Database"
                [appFeatureToggleOptions]="{whenInactive: whenInactiveEnum.hide}">
        <ion-item *ngIf="!latLon"
                  [button]="true"
                  (click)="openSearchAddressModal()">
          <ion-icon name="pin-outline" slot="start"></ion-icon>
          <ion-label>Localize</ion-label>
        </ion-item>

        <ion-item *ngIf="latLon">
          <ion-icon name="pin-outline" slot="start"></ion-icon>
          <ion-label position="floating">Localized</ion-label>
          <ion-input name="latLon" [(ngModel)]="latLon" placeholder="lat/lon"></ion-input>
          <ion-button (click)="openSearchAddressModal()" slot="end" color="white">
            <ion-icon name="map-outline"></ion-icon>
          </ion-button>
        </ion-item>

      </ion-list>
    </ion-accordion-group>

<!--    <ion-item-->
<!--      color="success"-->
<!--      *ngIf="!currentGenericFeed && !currentNativeFeed"-->
<!--      (click)="fetchDiscovery()"-->
<!--      [button]="true"-->
<!--    >-->
<!--      <ion-label> Reload </ion-label>-->
<!--    </ion-item>-->
    <ion-item
      [hidden]="loading || !discovery"
      (click)="previewCurrentFeed()"
      [disabled]="!currentSelectors && !currentNativeFeed"
      [button]="true"
    >
      <ion-label> Preview </ion-label>
    </ion-item>
    <ion-item
      [hidden]="loading || !discovery"
      [href]="getCurrentFeedUrl()"
      target="_blank"
      [disabled]="!currentSelectors && !currentNativeFeed"
      [button]="true"
    >
      <ion-label>Feed URL </ion-label>
    </ion-item>
    <div [appFeatureToggle]="featureTogglesEnum.Database">
      <ion-item-divider></ion-item-divider>
      <ion-item
        [color]="currentGenericFeed ? 'primary' : undefined"
        (click)="useCurrentGenericFeed()"
        *ngIf="currentGenericFeed"
        [button]="true"
      >
        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
        <ion-label> {{ saveLabelPrefix }} Generic Feed </ion-label>
      </ion-item>
      <ion-item
        [color]="currentNativeFeed ? 'primary' : undefined"
        (click)="useCurrentNativeFeed()"
        *ngIf="currentNativeFeed"
        [button]="true"
      >
        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
        <ion-label> {{ saveLabelPrefix }} Native Feed </ion-label>
      </ion-item>
    </div>
  </div>
  <div class="page-preview">
    <ion-toolbar>
      <form (ngSubmit)="checkClear(); fetchDiscovery()">
        <ion-searchbar
          placeholder="Enter URL"
          name="url"
          (ionChange)="checkClear()"
          [(ngModel)]="fetchOptions.websiteUrl"
        ></ion-searchbar>
        <ion-buttons slot="end">
          <ion-button color="dark" (click)="checkClear(); fetchDiscovery()">
            <ion-icon name="search-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </form>
    </ion-toolbar>
    <iframe
      style="flex: 1; position: relative"
      #iframeElement
      sandbox="allow-same-origin"
    ></iframe>
  </div>
</div>
